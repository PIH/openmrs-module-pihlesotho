<?xml version="1.0" encoding="UTF-8"?>
 
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog/1.9"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog/1.9
                  http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-1.9.xsd">


    <changeSet id="20250814-migrate-numeric-boolean" author="ball">
        <comment>
            For numeric boolean, migrated to coded true/false values.
        </comment>
        <sql>
            drop temporary table if exists temp_bool_obs;

            create temporary table temp_bool_obs
                select
                    o.obs_id, c.concept_id
                  from obs o, concept c
                 where c.concept_id = o.concept_id
                   and c.datatype_id = (select cd.concept_datatype_id from concept_datatype cd where cd.name like 'Boolean')
                   and o.value_numeric is not null
                   and o.voided = 0
                   ;

            -- insert obs with coded False
            insert into obs
                (person_id,
                 concept_id,
                 value_coded,
                 encounter_id,
                 obs_datetime,
                 location_id,
                 obs_group_id,
                 creator,
                 date_created,
                 voided,
                 uuid,
                 status,
                 previous_version
                )
            select
                o.person_id,
                t.concept_id,
                (select cn.concept_id from concept_name cn where cn.name like 'false' and cn.locale = 'en' and cn.locale_preferred = 1 and cn.voided = 0),
                o.encounter_id,
                o.obs_datetime,
                o.location_id,
                o.obs_group_id,
                o.creator,
                o.date_created,
                0,
                uuid(),
                o.status,
                t.obs_id
            from obs o
                inner join temp_bool_obs t on t.obs_id = o.obs_id
            where o.value_numeric = 0;

            -- insert obs with coded TRUE
            insert into obs
               (person_id,
                concept_id,
                value_coded,
                encounter_id,
                obs_datetime,
                location_id,
                obs_group_id,
                creator,
                date_created,
                voided,
                uuid,
                status,
                previous_version
               )
            select
                o.person_id,
                t.concept_id,
                (select cn.concept_id from concept_name cn where cn.name like 'true' and cn.locale = 'en' and cn.locale_preferred = 1 and cn.voided = 0),
                o.encounter_id,
                o.obs_datetime,
                o.location_id,
                o.obs_group_id,
                o.creator,
                o.date_created,
                0,
                uuid(),
                o.status,
                t.obs_id
            from obs o
            inner join temp_bool_obs t on t.obs_id = o.obs_id
            where o.value_numeric = 1;

            -- void numeric boolean obs
            update obs o
             inner join temp_bool_obs t on t.obs_id = o.obs_id
               set voided = 1,
                   voided_by = 1,
                   date_voided = now(),
                   void_reason = 'LSO-192 migrated to coded obs';

        </sql>
    </changeSet>
</databaseChangeLog>